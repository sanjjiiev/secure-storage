# ==========================================================
# Docker Compose - Decentralized File Storage System
# ==========================================================
# Runs the full system: Hardhat blockchain, DHT tracker,
# 3 storage nodes, and the API gateway.
#
# Usage:
#   docker compose up --build
#   docker compose down -v
# ==========================================================

services:
  # --------------------------------------------------------
  # Hardhat Ethereum Node
  # --------------------------------------------------------
  hardhat:
    build:
      context: ./blockchain
      dockerfile: Dockerfile
    ports:
      - "8545:8545"
    volumes:
      - shared_data:/shared
    networks:
      - storage_net
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8545').then(r => process.exit(0)).catch(() => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10

  # --------------------------------------------------------
  # DHT Tracker (Kademlia-style bootstrap node)
  # --------------------------------------------------------
  dht-tracker:
    build:
      context: ./dht_tracker
      dockerfile: Dockerfile
    ports:
      - "8500:8500"
    environment:
      - DHT_TRACKER_HOST=0.0.0.0
      - DHT_TRACKER_PORT=8500
      - NODE_STALE_TIMEOUT=60
    networks:
      - storage_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8500/health')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------
  # Storage Node 1
  # --------------------------------------------------------
  storage-node-1:
    build:
      context: ./storage_node
      dockerfile: Dockerfile
    ports:
      - "9001:9000"
    environment:
      - STORAGE_NODE_PORT=9000
      - STORAGE_DATA_DIR=/data/chunks
      - DHT_TRACKER_URL=http://dht-tracker:8500
      - NODE_ID=node-1
      - NODE_ADVERTISE_URL=http://storage-node-1:9000
    volumes:
      - storage_node_1_data:/data/chunks
    depends_on:
      dht-tracker:
        condition: service_healthy
    networks:
      - storage_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/health')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------
  # Storage Node 2
  # --------------------------------------------------------
  storage-node-2:
    build:
      context: ./storage_node
      dockerfile: Dockerfile
    ports:
      - "9002:9000"
    environment:
      - STORAGE_NODE_PORT=9000
      - STORAGE_DATA_DIR=/data/chunks
      - DHT_TRACKER_URL=http://dht-tracker:8500
      - NODE_ID=node-2
      - NODE_ADVERTISE_URL=http://storage-node-2:9000
    volumes:
      - storage_node_2_data:/data/chunks
    depends_on:
      dht-tracker:
        condition: service_healthy
    networks:
      - storage_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/health')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------
  # Storage Node 3
  # --------------------------------------------------------
  storage-node-3:
    build:
      context: ./storage_node
      dockerfile: Dockerfile
    ports:
      - "9003:9000"
    environment:
      - STORAGE_NODE_PORT=9000
      - STORAGE_DATA_DIR=/data/chunks
      - DHT_TRACKER_URL=http://dht-tracker:8500
      - NODE_ID=node-3
      - NODE_ADVERTISE_URL=http://storage-node-3:9000
    volumes:
      - storage_node_3_data:/data/chunks
    depends_on:
      dht-tracker:
        condition: service_healthy
    networks:
      - storage_net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/health')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------
  # API Gateway (FastAPI)
  # --------------------------------------------------------
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8000
      - DHT_TRACKER_URL=http://dht-tracker:8500
      - BLOCKCHAIN_URL=http://hardhat:8545
      - CONTRACT_ADDRESSES_FILE=/shared/contract_addresses.json
      - CHUNK_SIZE=262144
      - REPLICATION_FACTOR=3
    volumes:
      - shared_data:/shared
    depends_on:
      hardhat:
        condition: service_healthy
      dht-tracker:
        condition: service_healthy
      storage-node-1:
        condition: service_healthy
      storage-node-2:
        condition: service_healthy
      storage-node-3:
        condition: service_healthy
    networks:
      - storage_net

# --------------------------------------------------------
# Volumes for persistent storage
# --------------------------------------------------------
volumes:
  shared_data:
  storage_node_1_data:
  storage_node_2_data:
  storage_node_3_data:

# --------------------------------------------------------
# Shared network
# --------------------------------------------------------
networks:
  storage_net:
    driver: bridge
